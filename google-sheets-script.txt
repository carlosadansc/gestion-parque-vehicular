/** 
 * API FLOTA PRO v8.3 - Soporte para editar revisiones
 */

const CONFIG = {
  sheets: {
    "Vehiculos": [
      "id", "plate", "model", "assignedDriverId", "status", "image", "date_registered",
      "economicNumber", "inventory", "condition", "location", "vin", "odometer", "brand", "year", "type", "line", "color", "cylinders", "fuelType",
      "engineStatus", "clutchStatus", "transmissionStatus", "shifterStatus", "steeringStatus", "suspensionStatus", "tempGaugeStatus", "oilGaugeStatus",
      "tiresStatus", "shocksStatus", "brakesStatus", "batteryStatus", "lightsStatus", "hornStatus", "wipersStatus", "speedoStatus",
      "observations", "accessories_notes"
    ],
    "Revisiones": [
      "id", "date", "vehicleId", "inspectorName", "odometer", "observations",
      "engineStatus", "clutchStatus", "transmissionStatus", "shifterStatus", "steeringStatus", "suspensionStatus", "tempGaugeStatus", "oilGaugeStatus",
      "tiresStatus", "shocksStatus", "brakesStatus", "batteryStatus", "lightsStatus", "hornStatus", "wipersStatus", "speedoStatus"
    ],
    "Choferes": ["id", "name", "licenseType", "licenseNumber", "phone", "status", "assignedVehicleId", "image", "notes"],
    "Combustible": ["id", "date", "vehicleId", "driverId", "liters", "cost", "odometer"],
    "Incidencias": ["id", "date", "type", "title", "description", "vehicleId", "driverId", "status"],
    "Planeacion": ["id", "date", "vehicleId", "driverId", "areaId", "notes", "departureTime", "arrivalTime", "destination", "status"],
    "Areas": ["id", "name", "description"],
    "BitacorasViaje": ["id", "date", "departureTime", "arrivalTime", "driverId", "vehicleId", "initialOdometer", "finalOdometer", "destination", "areaId", "notes", "initialFuelLevel", "finalFuelLevel"],
    "Mantenimiento": ["id", "date", "vehicleId", "serviceType", "description", "quoteNumber", "quoteCost", "invoiceNumber", "invoiceAmount", "odometer", "provider", "entryDate", "exitDate", "status", "estimatedDeliveryDate", "internalDocumentNumber", "providerContact"],
    "TiposMantenimiento": ["id", "name"],
    "Ajustes": ["key", "value"],
    "Usuarios": ["id", "name", "username", "password", "role", "status", "lastLogin"]
  }
};

function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  Object.keys(CONFIG.sheets).forEach(name => getOrCreateSheet(ss, name));
  
  const userSheet = ss.getSheetByName("Usuarios");
  if (userSheet.getLastRow() < 2) {
    const defaultPassHash = Utilities.base64Encode(Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, "Macaco123"));
    userSheet.appendRow(["USR-1", "Administrador", "admin", defaultPassHash, "admin", "active", ""]);
  }

  const data = {};
  Object.keys(CONFIG.sheets).forEach(name => {
    data[name.toLowerCase()] = getSheetData(ss, name);
  });
  
  const response = {
    vehicles: data.vehiculos,
    inspections: data.revisiones,
    drivers: data.choferes,
    fuelEntries: data.combustible,
    incidents: data.incidencias,
    plannings: data.planeacion,
    areas: data.areas,
    travelLogs: data.bitacorasviaje,
    maintenanceRecords: data.mantenimiento,
    maintenanceTypes: data.tiposmantenimiento,
    settings: data.ajustes,
    users: data.usuarios
  };

  return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  try {
    const contents = JSON.parse(e.postData.contents);
    const action = contents.action;
    const d = contents.data;
    
    if (action === 'update-setting') {
      const sheet = getOrCreateSheet(ss, "Ajustes");
      updateSettingValue(sheet, d.key, d.value);
      return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
    }
    
    let sheetName = "";
     if (action === 'fuel' || action === 'update-fuel') sheetName = "Combustible";
    else if (action === 'incident') sheetName = "Incidencias";
    else if (action === 'vehicle' || action === 'update-vehicle') sheetName = "Vehiculos";
    else if (action === 'inspection' || action === 'update-inspection') sheetName = "Revisiones";
    else if (action === 'driver' || action === 'update-driver') sheetName = "Choferes";
    else if (action === 'planning' || action === 'update-planning') sheetName = "Planeacion";
    else if (action === 'area') sheetName = "Areas";
    else if (action === 'travel-log' || action === 'update-travel-log') sheetName = "BitacorasViaje";
    else if (action === 'maintenance' || action === 'update-maintenance') sheetName = "Mantenimiento";
    else if (action === 'maintenance-type') sheetName = "TiposMantenimiento";
    else if (action === 'user' || action === 'update-user') {
      sheetName = "Usuarios";
      if (d.password) d.password = Utilities.base64Encode(Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, d.password));
    }
    
    const sheet = getOrCreateSheet(ss, sheetName);
    const headersInSheet = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    if (action.startsWith('update-')) {
      updateRowDynamic(sheet, d.id, d, headersInSheet);
    } else {
      appendRowDynamic(sheet, d, headersInSheet);
    }
    
    return ContentService.createTextOutput(JSON.stringify({status: "success"})).setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function appendRowDynamic(sheet, dataObj, headers) {
  const row = headers.map(h => {
    if (h === 'date_registered') return new Date();
    return dataObj[h] !== undefined ? dataObj[h] : "";
  });
  sheet.appendRow(row);
}

function updateRowDynamic(sheet, id, dataObj, headers) {
  const data = sheet.getDataRange().getValues();
  const idColIndex = headers.indexOf("id");
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][idColIndex] === id) {
      headers.forEach((h, j) => {
        if (dataObj[h] !== undefined) {
          sheet.getRange(i + 1, j + 1).setValue(dataObj[h]);
        }
      });
      return true;
    }
  }
  return false;
}

function updateSettingValue(sheet, key, value) {
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === key) {
      sheet.getRange(i + 1, 2).setValue(value);
      return true;
    }
  }
  sheet.appendRow([key, value]);
  return true;
}

function getOrCreateSheet(ss, name) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    const headers = CONFIG.sheets[name];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground("#f1f5f9");
    sheet.setFrozenRows(1);
  }
  return sheet;
}

function getSheetData(ss, name) {
  const sheet = ss.getSheetByName(name);
  if (!sheet) return [];
  const range = sheet.getDataRange();
  const values = range.getValues();
  if (values.length < 2) return [];
  const headers = values.shift().map(h => h.toString().trim());
  return values.map((row) => {
    const obj = {};
    headers.forEach((h, i) => { if (h) obj[h] = row[i]; });
    return obj;
  });
}
